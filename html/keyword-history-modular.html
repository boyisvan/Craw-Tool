<!doctype html>

<html
  lang="vi"
  class="layout-menu-fixed layout-compact"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>L·ªãch s·ª≠ t·ª´ kh√≥a - Tool Craw Data ƒêa Lu·ªìng</title>

    <meta name="description" content="L·ªãch s·ª≠ t√¨m ki·∫øm t·ª´ kh√≥a" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="../assets/vendor/fonts/iconify-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/vendor/css/core.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>
    <script src="../assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y -->
    <div id="app-layout"></div>

    <!-- Core JS -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../assets/vendor/js/menu.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/layout.js"></script>

    <!-- Page JS -->
    <script>
      // Kh·ªüi t·∫°o layout manager
      const layoutManager = new LayoutManager();
      
      // N·ªôi dung trang Keyword History
      const pageContent = `
        <!-- Header -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="d-flex align-items-start row">
                <div class="col-sm-7">
                  <div class="card-body">
                    <h5 class="card-title text-primary mb-3">üìö L·ªãch s·ª≠ t·ª´ kh√≥a</h5>
                    <p class="mb-6">
                      Xem v√† qu·∫£n l√Ω l·ªãch s·ª≠ t√¨m ki·∫øm t·ª´ kh√≥a.<br />
                      Ph√¢n t√≠ch xu h∆∞·ªõng v√† hi·ªáu qu·∫£ t√¨m ki·∫øm.
                    </p>
                  </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                  <div class="card-body pb-0 px-0 px-md-6">
                    <img
                      src="../assets/img/illustrations/man-with-laptop.png"
                      height="175"
                      alt="Keyword History" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/chart-success.png"
                      alt="chart success"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">T·ªïng t·ª´ kh√≥a</p>
                <h4 class="card-title mb-3" id="totalKeywords">0</h4>
                <small class="text-success fw-medium">
                  <i class="icon-base bx bx-search"></i> ƒê√£ t√¨m ki·∫øm
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/wallet-info.png"
                      alt="wallet info"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">T·ª´ kh√≥a h√¥m nay</p>
                <h4 class="card-title mb-3" id="todayKeywords">0</h4>
                <small class="text-info fw-medium">
                  <i class="icon-base bx bx-calendar"></i> H√¥m nay
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/paypal.png"
                      alt="paypal"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">T·ª´ kh√≥a ph·ªï bi·∫øn</p>
                <h4 class="card-title mb-3" id="popularKeywords">0</h4>
                <small class="text-warning fw-medium">
                  <i class="icon-base bx bx-trending-up"></i> Nhi·ªÅu l·∫ßn
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/cc-primary.png"
                      alt="Credit Card"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">Website ho·∫°t ƒë·ªông</p>
                <h4 class="card-title mb-3" id="activeSites">0</h4>
                <small class="text-primary fw-medium">
                  <i class="icon-base bx bx-globe"></i> ƒêang theo d√µi
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">B·ªô l·ªçc</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="loadKeywordHistory()">
                  <i class="bx bx-refresh me-1"></i>T·∫£i l·∫°i
                </button>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <label for="filterSite" class="form-label">Website:</label>
                    <select class="form-select" id="filterSite" onchange="applyFilters()">
                      <option value="">T·∫•t c·∫£ website</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="filterDateFrom" class="form-label">T·ª´ ng√†y:</label>
                    <input type="date" class="form-control" id="filterDateFrom" onchange="applyFilters()">
                  </div>
                  <div class="col-md-3">
                    <label for="filterDateTo" class="form-label">ƒê·∫øn ng√†y:</label>
                    <input type="date" class="form-control" id="filterDateTo" onchange="applyFilters()">
                  </div>
                  <div class="col-md-3">
                    <label for="filterKeyword" class="form-label">T·ª´ kh√≥a:</label>
                    <input type="text" class="form-control" id="filterKeyword" placeholder="T√¨m t·ª´ kh√≥a..." onkeyup="applyFilters()">
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <label for="sortBy" class="form-label">S·∫Øp x·∫øp theo:</label>
                    <select class="form-select" id="sortBy" onchange="applyFilters()">
                      <option value="timestamp" selected>Th·ªùi gian</option>
                      <option value="keyword">T·ª´ kh√≥a</option>
                      <option value="site">Website</option>
                      <option value="resultCount">S·ªë k·∫øt qu·∫£</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="sortOrder" class="form-label">Th·ª© t·ª±:</label>
                    <select class="form-select" id="sortOrder" onchange="applyFilters()">
                      <option value="desc" selected>Gi·∫£m d·∫ßn</option>
                      <option value="asc">TƒÉng d·∫ßn</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Keyword History List -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">L·ªãch s·ª≠ t·ª´ kh√≥a</h5>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-danger btn-sm" onclick="clearAllHistory()">
                    <i class="bx bx-trash me-1"></i>X√≥a t·∫•t c·∫£
                  </button>
                  <button class="btn btn-outline-info btn-sm" onclick="exportHistory()">
                    <i class="bx bx-download me-1"></i>Xu·∫•t l·ªãch s·ª≠
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>T·ª´ kh√≥a</th>
                        <th>Website</th>
                        <th>S·ªë k·∫øt qu·∫£</th>
                        <th>Th·ªùi gian t√¨m ki·∫øm</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody id="keywordHistoryTable">
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                          </div>
                          <p class="mt-2 text-muted">ƒêang t·∫£i l·ªãch s·ª≠ t·ª´ kh√≥a...</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Popular Keywords -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title mb-0">T·ª´ kh√≥a ph·ªï bi·∫øn</h5>
              </div>
              <div class="card-body">
                <div id="popularKeywordsList">
                  <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p class="mt-2 text-muted">ƒêang t·∫£i t·ª´ kh√≥a ph·ªï bi·∫øn...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Variables
      let keywordHistory = [];
      let filteredHistory = [];

      // Render layout khi trang load
      document.addEventListener('DOMContentLoaded', function() {
        CommonUtils.checkLoginStatus();
        layoutManager.renderLayout('app-layout', pageContent);
        loadSites();
        loadKeywordHistory();
        loadPopularKeywords();
        loadStatistics();
        
        // Set default dates
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('filterDateTo').value = today.toISOString().split('T')[0];
        document.getElementById('filterDateFrom').value = lastWeek.toISOString().split('T')[0];
      });

      // Load sites
      async function loadSites() {
        await CommonUtils.loadSites();
        const select = document.getElementById('filterSite');
        
        CommonUtils.sites.forEach(site => {
          const option = document.createElement('option');
          option.value = site.key;
          option.textContent = site.name;
          select.appendChild(option);
        });
      }

      // Load keyword history
      async function loadKeywordHistory() {
        try {
          const response = await fetch('/api/keyword-history');
          const data = await response.json();
          
          if (data.success) {
            keywordHistory = data.data;
            applyFilters();
          } else {
            CommonUtils.showEmptyState('keywordHistoryTable', 'bx-search', 'Ch∆∞a c√≥ l·ªãch s·ª≠', 'Ch∆∞a c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm t·ª´ kh√≥a n√†o');
          }
        } catch (error) {
          console.error('Error loading keyword history:', error);
          CommonUtils.showEmptyState('keywordHistoryTable', 'bx-error', 'L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ t·ª´ kh√≥a');
        }
      }

      // Apply filters
      function applyFilters() {
        const siteFilter = document.getElementById('filterSite').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const keywordFilter = document.getElementById('filterKeyword').value.toLowerCase();
        const sortBy = document.getElementById('sortBy').value;
        const sortOrder = document.getElementById('sortOrder').value;

        filteredHistory = keywordHistory.filter(item => {
          // Site filter
          if (siteFilter && item.siteKey !== siteFilter) return false;
          
          // Date filter
          if (dateFrom && new Date(item.timestamp) < new Date(dateFrom)) return false;
          if (dateTo && new Date(item.timestamp) > new Date(dateTo + 'T23:59:59')) return false;
          
          // Keyword filter
          if (keywordFilter && !item.keyword.toLowerCase().includes(keywordFilter)) return false;
          
          return true;
        });

        // Sort
        filteredHistory.sort((a, b) => {
          let aVal = a[sortBy];
          let bVal = b[sortBy];
          
          if (sortBy === 'timestamp') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
          }
          
          if (sortOrder === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        updateKeywordHistoryTable(filteredHistory);
      }

      // Update keyword history table
      function updateKeywordHistoryTable(history) {
        const tbody = document.getElementById('keywordHistoryTable');
        
        if (history.length === 0) {
          CommonUtils.showEmptyState('keywordHistoryTable', 'bx-search', 'Kh√¥ng c√≥ d·ªØ li·ªáu', 'Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ ph√π h·ª£p v·ªõi b·ªô l·ªçc');
          return;
        }

        const html = history.map(item => {
          const timeAgo = CommonUtils.getTimeAgo(item.timestamp);
          const statusClass = item.status === 'success' ? 'success' : 'warning';
          const statusText = item.status === 'success' ? 'Th√†nh c√¥ng' : 'C√≥ l·ªói';
          const statusIcon = item.status === 'success' ? 'bx-check-circle' : 'bx-error-circle';
          
          return `
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="bx bx-search me-2 text-primary"></i>
                  <strong>${item.keyword}</strong>
                </div>
              </td>
              <td>
                <span class="badge bg-info">${item.siteName}</span>
              </td>
              <td>
                <span class="fw-bold text-success">${CommonUtils.formatNumber(item.resultCount)}</span>
              </td>
              <td>
                <small class="text-muted">${timeAgo}</small>
                <br>
                <small class="text-muted">${CommonUtils.formatDate(item.timestamp)}</small>
              </td>
              <td>
                <span class="badge bg-${statusClass}">
                  <i class="bx ${statusIcon} me-1"></i>${statusText}
                </span>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="repeatSearch('${item.keyword}', '${item.siteKey}')">
                      <i class="bx bx-refresh me-2"></i>T√¨m ki·∫øm l·∫°i
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="viewSearchResults('${item.id}')">
                      <i class="bx bx-show me-2"></i>Xem k·∫øt qu·∫£
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="deleteHistoryItem('${item.id}')">
                      <i class="bx bx-trash me-2"></i>X√≥a
                    </a></li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = html;
      }

      // Load popular keywords
      async function loadPopularKeywords() {
        try {
          const response = await fetch('/api/popular-keywords');
          const data = await response.json();
          
          if (data.success) {
            updatePopularKeywords(data.data);
          } else {
            CommonUtils.showEmptyState('popularKeywordsList', 'bx-trending-up', 'Ch∆∞a c√≥ d·ªØ li·ªáu', 'Ch∆∞a c√≥ t·ª´ kh√≥a ph·ªï bi·∫øn n√†o');
          }
        } catch (error) {
          console.error('Error loading popular keywords:', error);
          CommonUtils.showEmptyState('popularKeywordsList', 'bx-error', 'L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i t·ª´ kh√≥a ph·ªï bi·∫øn');
        }
      }

      // Update popular keywords
      function updatePopularKeywords(keywords) {
        const container = document.getElementById('popularKeywordsList');
        
        if (keywords.length === 0) {
          CommonUtils.showEmptyState('popularKeywordsList', 'bx-trending-up', 'Ch∆∞a c√≥ d·ªØ li·ªáu', 'Ch∆∞a c√≥ t·ª´ kh√≥a ph·ªï bi·∫øn n√†o');
          return;
        }

        const html = keywords.map((keyword, index) => {
          const rankClass = index < 3 ? 'primary' : 'secondary';
          const rankIcon = index === 0 ? 'bx-trophy' : index === 1 ? 'bx-medal' : index === 2 ? 'bx-award' : 'bx-hash';
          
          return `
            <div class="d-flex align-items-center justify-content-between mb-3 p-3 border rounded">
              <div class="d-flex align-items-center">
                <div class="avatar flex-shrink-0 me-3">
                  <span class="avatar-initial rounded bg-label-${rankClass}">
                    <i class="bx ${rankIcon}"></i>
                  </span>
                </div>
                <div>
                  <h6 class="mb-0">${keyword.keyword}</h6>
                  <small class="text-muted">${keyword.siteName}</small>
                </div>
              </div>
              <div class="text-end">
                <span class="badge bg-${rankClass}">${keyword.count} l·∫ßn</span>
                <br>
                <small class="text-muted">${CommonUtils.formatNumber(keyword.totalResults)} k·∫øt qu·∫£</small>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
      }

      // Load statistics
      async function loadStatistics() {
        try {
          const response = await fetch('/api/keyword-statistics');
          const data = await response.json();
          
          if (data.success) {
            updateStatistics(data.data);
          }
        } catch (error) {
          console.error('Error loading statistics:', error);
        }
      }

      // Update statistics
      function updateStatistics(stats) {
        document.getElementById('totalKeywords').textContent = CommonUtils.formatNumber(stats.totalKeywords || 0);
        document.getElementById('todayKeywords').textContent = CommonUtils.formatNumber(stats.todayKeywords || 0);
        document.getElementById('popularKeywords').textContent = CommonUtils.formatNumber(stats.popularKeywords || 0);
        document.getElementById('activeSites').textContent = CommonUtils.formatNumber(stats.activeSites || 0);
      }

      // Repeat search
      function repeatSearch(keyword, siteKey) {
        // Redirect to keyword search page with pre-filled data
        const params = new URLSearchParams({
          keyword: keyword,
          site: siteKey
        });
        window.location.href = `/html/keyword-search-modular.html?${params.toString()}`;
      }

      // View search results
      function viewSearchResults(searchId) {
        CommonUtils.showAlert('ƒêang t·∫£i k·∫øt qu·∫£ t√¨m ki·∫øm...', 'info');
        
        // Simulate loading results
        setTimeout(() => {
          CommonUtils.showAlert('Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm', 'success');
        }, 1000);
      }

      // Delete history item
      function deleteHistoryItem(itemId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y kh·ªèi l·ªãch s·ª≠?')) {
          CommonUtils.showAlert('ƒê√£ x√≥a m·ª•c kh·ªèi l·ªãch s·ª≠!', 'success');
          loadKeywordHistory();
        }
      }

      // Clear all history
      function clearAllHistory() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ t·ª´ kh√≥a? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
          CommonUtils.showAlert('ƒêang x√≥a l·ªãch s·ª≠...', 'info');
          
          // Simulate clear
          setTimeout(() => {
            CommonUtils.showAlert('ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠!', 'success');
            loadKeywordHistory();
            loadStatistics();
          }, 2000);
        }
      }

      // Export history
      function exportHistory() {
        CommonUtils.showAlert('ƒêang xu·∫•t l·ªãch s·ª≠...', 'info');
        
        // Simulate export
        setTimeout(() => {
          CommonUtils.showAlert('ƒê√£ xu·∫•t l·ªãch s·ª≠ th√†nh c√¥ng!', 'success');
        }, 2000);
      }
    </script>
  </body>
</html>
