<!doctype html>

<html
  lang="vi"
  class="layout-menu-fixed layout-compact"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Gi√°m s√°t Website - Tool Craw Data ƒêa Lu·ªìng</title>

    <meta name="description" content="Gi√°m s√°t tr·∫°ng th√°i c√°c website" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="../assets/vendor/fonts/iconify-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/vendor/css/core.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>
    <script src="../assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y -->
    <div id="app-layout"></div>

    <!-- Core JS -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../assets/vendor/js/menu.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/layout.js"></script>

    <!-- Page JS -->
    <script>
      // Kh·ªüi t·∫°o layout manager
      const layoutManager = new LayoutManager();
      
      // N·ªôi dung trang Site Monitor
      const pageContent = `
        <!-- Header -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="d-flex align-items-start row">
                <div class="col-sm-7">
                  <div class="card-body">
                    <h5 class="card-title text-primary mb-3">üìä Gi√°m s√°t Website</h5>
                    <p class="mb-6">
                      Theo d√µi tr·∫°ng th√°i ho·∫°t ƒë·ªông c·ªßa t·∫•t c·∫£ c√°c website.<br />
                      Ki·ªÉm tra k·∫øt n·ªëi, s·∫£n ph·∫©m m·ªõi v√† hi·ªáu su·∫•t thu th·∫≠p d·ªØ li·ªáu.
                    </p>
                  </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                  <div class="card-body pb-0 px-0 px-md-6">
                    <img
                      src="../assets/img/illustrations/man-with-laptop.png"
                      height="175"
                      alt="Site Monitor" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/chart-success.png"
                      alt="chart success"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">Website ho·∫°t ƒë·ªông</p>
                <h4 class="card-title mb-3" id="activeSites">0</h4>
                <small class="text-success fw-medium">
                  <i class="icon-base bx bx-check-circle"></i> ƒêang ho·∫°t ƒë·ªông
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/wallet-info.png"
                      alt="wallet info"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">Website l·ªói</p>
                <h4 class="card-title mb-3" id="errorSites">0</h4>
                <small class="text-danger fw-medium">
                  <i class="icon-base bx bx-error-circle"></i> C·∫ßn ki·ªÉm tra
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/paypal.png"
                      alt="paypal"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">C√≥ s·∫£n ph·∫©m m·ªõi</p>
                <h4 class="card-title mb-3" id="newProductSites">0</h4>
                <small class="text-warning fw-medium">
                  <i class="icon-base bx bx-package"></i> C·∫ßn thu th·∫≠p
                </small>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between mb-4">
                  <div class="avatar flex-shrink-0">
                    <img
                      src="../assets/img/icons/unicons/cc-primary.png"
                      alt="Credit Card"
                      class="rounded" />
                  </div>
                </div>
                <p class="mb-1">T·ªïng website</p>
                <h4 class="card-title mb-3" id="totalSites">0</h4>
                <small class="text-info fw-medium">
                  <i class="icon-base bx bx-globe"></i> ƒêang theo d√µi
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Monitor Controls -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">ƒêi·ªÅu khi·ªÉn gi√°m s√°t</h5>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-primary" onclick="checkAllSites()">
                    <i class="bx bx-refresh me-1"></i>Ki·ªÉm tra t·∫•t c·∫£
                  </button>
                  <button class="btn btn-outline-success" onclick="startAutoMonitor()">
                    <i class="bx bx-play me-1"></i>B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông
                  </button>
                  <button class="btn btn-outline-warning" onclick="stopAutoMonitor()">
                    <i class="bx bx-pause me-1"></i>D·ª´ng t·ª± ƒë·ªông
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label for="monitorInterval" class="form-label">Kho·∫£ng th·ªùi gian ki·ªÉm tra (ph√∫t)</label>
                    <select class="form-select" id="monitorInterval">
                      <option value="5">5 ph√∫t</option>
                      <option value="10" selected>10 ph√∫t</option>
                      <option value="15">15 ph√∫t</option>
                      <option value="30">30 ph√∫t</option>
                      <option value="60">1 gi·ªù</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Tr·∫°ng th√°i gi√°m s√°t</label>
                    <div id="monitorStatus" class="mt-2">
                      <span class="badge bg-secondary">Ch∆∞a b·∫Øt ƒë·∫ßu</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Site Status List -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Tr·∫°ng th√°i Website</h5>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-primary btn-sm" onclick="filterSites('all')">
                    T·∫•t c·∫£
                  </button>
                  <button class="btn btn-outline-success btn-sm" onclick="filterSites('active')">
                    Ho·∫°t ƒë·ªông
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="filterSites('new')">
                    C√≥ m·ªõi
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="filterSites('error')">
                    L·ªói
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Website</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>S·∫£n ph·∫©m m·ªõi</th>
                        <th>L·∫ßn ki·ªÉm tra cu·ªëi</th>
                        <th>Th·ªùi gian ph·∫£n h·ªìi</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody id="siteStatusTable">
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                          </div>
                          <p class="mt-2 text-muted">ƒêang t·∫£i tr·∫°ng th√°i website...</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Variables
      let siteStatuses = [];
      let autoMonitorInterval = null;
      let currentFilter = 'all';

      // Render layout khi trang load
      document.addEventListener('DOMContentLoaded', function() {
        CommonUtils.checkLoginStatus();
        layoutManager.renderLayout('app-layout', pageContent);
        loadSites();
        checkAllSites();
      });

      // Load sites
      async function loadSites() {
        await CommonUtils.loadSites();
        document.getElementById('totalSites').textContent = CommonUtils.sites.length;
      }

      // Check all sites
      async function checkAllSites() {
        CommonUtils.showLoading('siteStatusTable', 'ƒêang ki·ªÉm tra t·∫•t c·∫£ website...');
        CommonUtils.updateConnectionStatus('ƒêang ki·ªÉm tra...', 'warning', 'monitorStatus');

        try {
          const response = await fetch('/api/check-all-sites');
          const data = await response.json();
          
          if (data.success) {
            siteStatuses = data.data;
            updateSiteStatusTable(siteStatuses);
            updateStatistics(siteStatuses);
            CommonUtils.updateConnectionStatus('ƒê√£ ki·ªÉm tra xong', 'success', 'monitorStatus');
          } else {
            CommonUtils.showAlert('L·ªói khi ki·ªÉm tra website: ' + data.message, 'error');
            CommonUtils.showEmptyState('siteStatusTable', 'bx-error', 'L·ªói ki·ªÉm tra', 'Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i website');
          }
        } catch (error) {
          console.error('Error checking sites:', error);
          CommonUtils.showAlert('L·ªói khi ki·ªÉm tra website', 'error');
          CommonUtils.showEmptyState('siteStatusTable', 'bx-error', 'L·ªói ki·ªÉm tra', 'Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i website');
        }
      }

      // Update site status table
      function updateSiteStatusTable(statuses) {
        const tbody = document.getElementById('siteStatusTable');
        
        if (statuses.length === 0) {
          CommonUtils.showEmptyState('siteStatusTable', 'bx-globe', 'Ch∆∞a c√≥ website', 'Ch∆∞a c√≥ website n√†o ƒë·ªÉ gi√°m s√°t');
          return;
        }

        const filteredStatuses = filterStatuses(statuses);
        const html = filteredStatuses.map(status => {
          const statusClass = getStatusClass(status.status);
          const statusIcon = getStatusIcon(status.status);
          const statusText = getStatusText(status.status);
          const lastCheck = CommonUtils.getTimeAgo(new Date());
          const responseTime = Math.floor(Math.random() * 2000) + 100; // Simulate response time
          
          return `
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar flex-shrink-0 me-3">
                    <span class="avatar-initial rounded bg-label-${statusClass}">
                      <i class="bx ${statusIcon}"></i>
                    </span>
                  </div>
                  <div>
                    <h6 class="mb-0">${status.site}</h6>
                    <small class="text-muted">${getSiteUrl(status.site)}</small>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge bg-${statusClass}">
                  <i class="bx ${statusIcon} me-1"></i>${statusText}
                </span>
              </td>
              <td>
                ${status.status === 'new' ? '<span class="badge bg-warning">C√≥ m·ªõi</span>' : '<span class="badge bg-secondary">Kh√¥ng</span>'}
              </td>
              <td>
                <small class="text-muted">${lastCheck}</small>
              </td>
              <td>
                <span class="text-success">${responseTime}ms</span>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="testSite('${status.site}')">
                      <i class="bx bx-test-tube me-2"></i>Ki·ªÉm tra l·∫°i
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="viewSiteDetails('${status.site}')">
                      <i class="bx bx-info-circle me-2"></i>Chi ti·∫øt
                    </a></li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = html;
      }

      // Filter statuses
      function filterStatuses(statuses) {
        if (currentFilter === 'all') return statuses;
        return statuses.filter(status => {
          if (currentFilter === 'active') return status.status === 'no_new';
          if (currentFilter === 'new') return status.status === 'new';
          if (currentFilter === 'error') return status.status === 'error';
          return true;
        });
      }

      // Get status class
      function getStatusClass(status) {
        switch (status) {
          case 'new': return 'warning';
          case 'no_new': return 'success';
          case 'error': return 'danger';
          default: return 'secondary';
        }
      }

      // Get status icon
      function getStatusIcon(status) {
        switch (status) {
          case 'new': return 'bx-package';
          case 'no_new': return 'bx-check-circle';
          case 'error': return 'bx-error-circle';
          default: return 'bx-question-mark';
        }
      }

      // Get status text
      function getStatusText(status) {
        switch (status) {
          case 'new': return 'C√≥ s·∫£n ph·∫©m m·ªõi';
          case 'no_new': return 'Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng';
          case 'error': return 'L·ªói k·∫øt n·ªëi';
          default: return 'Kh√¥ng x√°c ƒë·ªãnh';
        }
      }

      // Get site URL
      function getSiteUrl(siteName) {
        const site = CommonUtils.sites.find(s => s.name === siteName);
        return site ? site.baseUrl : 'N/A';
      }

      // Update statistics
      function updateStatistics(statuses) {
        const activeCount = statuses.filter(s => s.status === 'no_new').length;
        const errorCount = statuses.filter(s => s.status === 'error').length;
        const newCount = statuses.filter(s => s.status === 'new').length;

        document.getElementById('activeSites').textContent = activeCount;
        document.getElementById('errorSites').textContent = errorCount;
        document.getElementById('newProductSites').textContent = newCount;
      }

      // Filter sites
      function filterSites(filter) {
        currentFilter = filter;
        updateSiteStatusTable(siteStatuses);
      }

      // Test individual site
      function testSite(siteName) {
        CommonUtils.showAlert(`ƒêang ki·ªÉm tra ${siteName}...`, 'info');
        
        // Simulate test
        setTimeout(() => {
          CommonUtils.showAlert(`ƒê√£ ki·ªÉm tra ${siteName} th√†nh c√¥ng!`, 'success');
          checkAllSites();
        }, 2000);
      }

      // View site details
      function viewSiteDetails(siteName) {
        CommonUtils.showAlert(`Xem chi ti·∫øt ${siteName}`, 'info');
      }

      // Start auto monitor
      function startAutoMonitor() {
        const interval = parseInt(document.getElementById('monitorInterval').value) * 60 * 1000; // Convert to milliseconds
        
        if (autoMonitorInterval) {
          clearInterval(autoMonitorInterval);
        }

        autoMonitorInterval = setInterval(() => {
          checkAllSites();
        }, interval);

        CommonUtils.updateConnectionStatus('ƒêang gi√°m s√°t t·ª± ƒë·ªông', 'success', 'monitorStatus');
        CommonUtils.showAlert('ƒê√£ b·∫Øt ƒë·∫ßu gi√°m s√°t t·ª± ƒë·ªông!', 'success');
      }

      // Stop auto monitor
      function stopAutoMonitor() {
        if (autoMonitorInterval) {
          clearInterval(autoMonitorInterval);
          autoMonitorInterval = null;
        }

        CommonUtils.updateConnectionStatus('ƒê√£ d·ª´ng gi√°m s√°t', 'secondary', 'monitorStatus');
        CommonUtils.showAlert('ƒê√£ d·ª´ng gi√°m s√°t t·ª± ƒë·ªông!', 'info');
      }
    </script>
  </body>
</html>
