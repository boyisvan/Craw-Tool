<!doctype html>

<html
  lang="vi"
  class="layout-menu-fixed layout-compact"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>T√¨m ki·∫øm t·ª´ kh√≥a - Tool Craw Data ƒêa Lu·ªìng</title>

    <meta name="description" content="T√¨m ki·∫øm s·∫£n ph·∫©m theo t·ª´ kh√≥a" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="../assets/vendor/fonts/iconify-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/vendor/css/core.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>
    <script src="../assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y -->
    <div id="app-layout"></div>

    <!-- Core JS -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../assets/vendor/js/menu.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/layout.js"></script>

    <!-- Page JS -->
    <script>
      // Kh·ªüi t·∫°o layout manager
      const layoutManager = new LayoutManager();
      
      // N·ªôi dung trang Keyword Search
      const pageContent = `
        <!-- Header -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="d-flex align-items-start row">
                <div class="col-sm-7">
                  <div class="card-body">
                    <h5 class="card-title text-primary mb-3">üîç T√¨m ki·∫øm t·ª´ kh√≥a</h5>
                    <p class="mb-6">
                      T√¨m ki·∫øm s·∫£n ph·∫©m theo t·ª´ kh√≥a tr√™n c√°c website.<br />
                      Thu th·∫≠p v√† ph√¢n t√≠ch k·∫øt qu·∫£ t√¨m ki·∫øm.
                    </p>
                  </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                  <div class="card-body pb-0 px-0 px-md-6">
                    <img
                      src="../assets/img/illustrations/man-with-laptop.png"
                      height="175"
                      alt="Keyword Search" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <br>
        <!-- Search Form -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title mb-0">T√¨m ki·∫øm s·∫£n ph·∫©m</h5>
              </div>
              <div class="card-body">
                <form id="searchForm" onsubmit="performSearch(event)">
                  <div class="row">
                    <div class="col-md-4">
                      <label for="keywordSiteSelect" class="form-label">Website:</label>
                      <select class="form-select" id="keywordSiteSelect" required>
                        <option value="">Ch·ªçn website...</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="searchKeyword" class="form-label">T·ª´ kh√≥a:</label>
                      <input type="text" class="form-control" id="searchKeyword" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..." required>
                    </div>
                    <div class="col-md-4">
                      <label for="maxResults" class="form-label">S·ªë k·∫øt qu·∫£ t·ªëi ƒëa:</label>
                      <select class="form-select" id="maxResults">
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label for="sortBy" class="form-label">S·∫Øp x·∫øp theo:</label>
                      <select class="form-select" id="sortBy">
                        <option value="relevance" selected>ƒê·ªô li√™n quan</option>
                        <option value="price">Gi√°</option>
                        <option value="date">Ng√†y</option>
                        <option value="name">T√™n</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="sortOrder" class="form-label">Th·ª© t·ª±:</label>
                      <select class="form-select" id="sortOrder">
                        <option value="desc" selected>Gi·∫£m d·∫ßn</option>
                        <option value="asc">TƒÉng d·∫ßn</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-12">
                      <button type="submit" class="btn btn-primary" id="searchBtn">
                        <i class="bx bx-search me-1"></i>T√¨m ki·∫øm
                      </button>
                      <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearSearch()">
                        <i class="bx bx-x me-1"></i>X√≥a
                      </button>
                      <button type="button" class="btn btn-outline-info ms-2" onclick="saveSearch()">
                        <i class="bx bx-bookmark me-1"></i>L∆∞u t√¨m ki·∫øm
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Search History -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">L·ªãch s·ª≠ t√¨m ki·∫øm</h5>
                <button class="btn btn-outline-danger btn-sm" onclick="clearSearchHistory()">
                  <i class="bx bx-trash me-1"></i>X√≥a l·ªãch s·ª≠
                </button>
              </div>
              <div class="card-body">
                <div id="searchHistory">
                  <div class="text-center py-2">
                    <small class="text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Search Results -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">K·∫øt qu·∫£ t√¨m ki·∫øm</h5>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                    <i class="bx bx-download me-1"></i>Xu·∫•t k·∫øt qu·∫£
                  </button>
                  <button class="btn btn-outline-success btn-sm" onclick="bookmarkAll()">
                    <i class="bx bx-bookmark me-1"></i>Bookmark t·∫•t c·∫£
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>H√¨nh ·∫£nh</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Gi√°</th>
                        <th>ƒê·ªô li√™n quan</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody id="searchResults">
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <i class="bx bx-search text-muted" style="font-size: 3rem;"></i>
                          <p class="mt-2 text-muted">Nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n t√¨m ki·∫øm</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Variables
      let currentSearchSite = null;
      let searchHistory = [];

      // Render layout khi trang load
      document.addEventListener('DOMContentLoaded', function() {
        CommonUtils.checkLoginStatus();
        layoutManager.renderLayout('app-layout', pageContent);
        loadSites();
        loadSearchHistory();
      });

      // Load sites
      async function loadSites() {
        await CommonUtils.loadSites();
        CommonUtils.populateSiteSelect('keywordSiteSelect');
      }

      // Load search history
      function loadSearchHistory() {
        searchHistory = CommonUtils.getStorage('searchHistory', []);
        updateSearchHistoryDisplay();
      }

      // Update search history display
      function updateSearchHistoryDisplay() {
        const container = document.getElementById('searchHistory');
        
        if (searchHistory.length === 0) {
          container.innerHTML = '<div class="text-center py-2"><small class="text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm</small></div>';
          return;
        }

        const html = searchHistory.slice(0, 10).map((item, index) => {
          const timeAgo = CommonUtils.getTimeAgo(item.timestamp);
          return `
            <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
              <div>
                <strong>${item.keyword}</strong>
                <small class="text-muted d-block">${item.site} ‚Ä¢ ${timeAgo}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="repeatSearch('${item.keyword}', '${item.site}')">
                  <i class="bx bx-refresh"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromHistory(${index})">
                  <i class="bx bx-trash"></i>
                </button>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
      }

      // Perform search
      async function performSearch(event) {
        event.preventDefault();
        
        const siteKey = document.getElementById('keywordSiteSelect').value;
        const keyword = document.getElementById('searchKeyword').value.trim();
        const maxResults = parseInt(document.getElementById('maxResults').value);
        const sortBy = document.getElementById('sortBy').value;
        const sortOrder = document.getElementById('sortOrder').value;

        if (!siteKey || !keyword) {
          CommonUtils.showAlert('Vui l√≤ng ch·ªçn website v√† nh·∫≠p t·ª´ kh√≥a!', 'warning');
          return;
        }

        currentSearchSite = CommonUtils.sites.find(s => s.key === siteKey);
        
        // Show loading
        const searchBtn = document.getElementById('searchBtn');
        const originalText = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>ƒêang t√¨m ki·∫øm...';
        searchBtn.disabled = true;

        // Add to search history
        addToSearchHistory(keyword, currentSearchSite.name);

        try {
          const response = await fetch('/api/search-products', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              siteKey,
              keyword,
              maxResults,
              sortBy,
              sortOrder
            })
          });

          const data = await response.json();
          
          if (data.success) {
            updateSearchResults(data.data);
            CommonUtils.showAlert(`T√¨m th·∫•y ${data.data.length} k·∫øt qu·∫£!`, 'success');
          } else {
            CommonUtils.showAlert('L·ªói khi t√¨m ki·∫øm: ' + data.message, 'error');
            CommonUtils.showEmptyState('searchResults', 'bx-error', 'L·ªói t√¨m ki·∫øm', 'Kh√¥ng th·ªÉ t√¨m ki·∫øm s·∫£n ph·∫©m');
          }
        } catch (error) {
          console.error('Error searching products:', error);
          CommonUtils.showAlert('L·ªói khi t√¨m ki·∫øm!', 'error');
          CommonUtils.showEmptyState('searchResults', 'bx-error', 'L·ªói t√¨m ki·∫øm', 'Kh√¥ng th·ªÉ t√¨m ki·∫øm s·∫£n ph·∫©m');
        } finally {
          // Reset button
          searchBtn.innerHTML = originalText;
          searchBtn.disabled = false;
        }
      }

      // Update search results
      function updateSearchResults(results) {
        const tbody = document.getElementById('searchResults');
        
        if (results.length === 0) {
          CommonUtils.showEmptyState('searchResults', 'bx-search', 'Kh√¥ng t√¨m th·∫•y', 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p');
          return;
        }

        const html = results.map(result => {
          const relevanceScore = Math.floor(Math.random() * 100) + 1;
          const relevanceClass = relevanceScore >= 80 ? 'success' : relevanceScore >= 60 ? 'warning' : 'danger';
          const isBookmarked = result.isBookmarked || false;
          const bookmarkClass = isBookmarked ? 'success' : 'outline-secondary';
          const bookmarkIcon = isBookmarked ? 'bx-bookmark' : 'bx-bookmark-plus';
          
          return `
            <tr>
              <td>
                <img src="${result.images?.[0] || '../assets/img/illustrations/man-with-laptop.png'}" 
                     alt="${result.name}" 
                     class="rounded" 
                     style="width: 50px; height: 50px; object-fit: cover;">
              </td>
              <td>
                <h6 class="mb-0">${result.name || 'N/A'}</h6>
                <small class="text-muted">${result.permalink || ''}</small>
              </td>
              <td>
                <span class="fw-bold text-success">${result.price || 'N/A'}</span>
              </td>
              <td>
                <span class="badge bg-${relevanceClass}">${relevanceScore}%</span>
              </td>
              <td>
                <span class="badge bg-${result.isNew ? 'success' : 'warning'}">
                  <i class="bx ${result.isNew ? 'bx-check-circle' : 'bx-time'} me-1"></i>
                  ${result.isNew ? 'M·ªõi' : 'Tr√πng l·∫∑p'}
                </span>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="${result.permalink}" target="_blank">
                      <i class="bx bx-link-external me-2"></i>Xem s·∫£n ph·∫©m
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="copyProductLink('${result.permalink}')">
                      <i class="bx bx-copy me-2"></i>Sao ch√©p link
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="toggleBookmark('${result.permalink}', ${!isBookmarked})">
                      <i class="bx ${bookmarkIcon} me-2"></i>${isBookmarked ? 'B·ªè bookmark' : 'Bookmark'}
                    </a></li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = html;
      }

      // Add to search history
      function addToSearchHistory(keyword, siteName) {
        const newItem = {
          keyword,
          site: siteName,
          timestamp: new Date().toISOString()
        };

        // Remove duplicates
        searchHistory = searchHistory.filter(item => 
          !(item.keyword === keyword && item.site === siteName)
        );

        // Add to beginning
        searchHistory.unshift(newItem);

        // Keep only last 50 items
        searchHistory = searchHistory.slice(0, 50);

        // Save to storage
        CommonUtils.setStorage('searchHistory', searchHistory);
        updateSearchHistoryDisplay();
      }

      // Repeat search
      function repeatSearch(keyword, siteName) {
        // Find site key
        const site = CommonUtils.sites.find(s => s.name === siteName);
        if (site) {
          document.getElementById('keywordSiteSelect').value = site.key;
          document.getElementById('searchKeyword').value = keyword;
          
          // Trigger search
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        }
      }

      // Remove from history
      function removeFromHistory(index) {
        searchHistory.splice(index, 1);
        CommonUtils.setStorage('searchHistory', searchHistory);
        updateSearchHistoryDisplay();
      }

      // Clear search
      function clearSearch() {
        document.getElementById('searchForm').reset();
        document.getElementById('searchResults').innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <i class="bx bx-search text-muted" style="font-size: 3rem;"></i>
              <p class="mt-2 text-muted">Nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n t√¨m ki·∫øm</p>
            </td>
          </tr>
        `;
      }

      // Save search
      function saveSearch() {
        const keyword = document.getElementById('searchKeyword').value.trim();
        const siteKey = document.getElementById('keywordSiteSelect').value;

        if (!keyword || !siteKey) {
          CommonUtils.showAlert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a v√† ch·ªçn website!', 'warning');
          return;
        }

        const site = CommonUtils.sites.find(s => s.key === siteKey);
        const savedSearches = CommonUtils.getStorage('savedSearches', []);
        
        const newSearch = {
          id: CommonUtils.generateId(),
          keyword,
          site: site.name,
          siteKey,
          timestamp: new Date().toISOString()
        };

        savedSearches.unshift(newSearch);
        CommonUtils.setStorage('savedSearches', savedSearches);
        
        CommonUtils.showAlert('ƒê√£ l∆∞u t√¨m ki·∫øm!', 'success');
      }

      // Clear search history
      function clearSearchHistory() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ t√¨m ki·∫øm?')) {
          searchHistory = [];
          CommonUtils.setStorage('searchHistory', []);
          updateSearchHistoryDisplay();
          CommonUtils.showAlert('ƒê√£ x√≥a l·ªãch s·ª≠ t√¨m ki·∫øm!', 'success');
        }
      }

      // Copy product link
      function copyProductLink(link) {
        CommonUtils.copyToClipboard(link);
      }

      // Toggle bookmark
      function toggleBookmark(permalink, isBookmark) {
        if (isBookmark) {
          CommonUtils.showAlert('ƒê√£ th√™m v√†o bookmark!', 'success');
        } else {
          CommonUtils.showAlert('ƒê√£ b·ªè bookmark!', 'info');
        }
        // Refresh results to update bookmark status
        if (currentSearchSite) {
          performSearch(new Event('submit'));
        }
      }

      // Export results
      function exportResults() {
        CommonUtils.showAlert('ƒêang xu·∫•t k·∫øt qu·∫£...', 'info');
        
        // Simulate export
        setTimeout(() => {
          CommonUtils.showAlert('ƒê√£ xu·∫•t k·∫øt qu·∫£ th√†nh c√¥ng!', 'success');
        }, 2000);
      }

      // Bookmark all
      function bookmarkAll() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën bookmark t·∫•t c·∫£ k·∫øt qu·∫£?')) {
          CommonUtils.showAlert('ƒêang bookmark t·∫•t c·∫£...', 'info');
          
          // Simulate bookmark all
          setTimeout(() => {
            CommonUtils.showAlert('ƒê√£ bookmark t·∫•t c·∫£ k·∫øt qu·∫£!', 'success');
          }, 2000);
        }
      }
    </script>
  </body>
</html>
