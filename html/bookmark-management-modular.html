<!doctype html>

<html
  lang="vi"
  class="layout-menu-fixed layout-compact"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Qu·∫£n l√Ω Bookmark - Tool Craw Data ƒêa Lu·ªìng</title>

    <meta name="description" content="Qu·∫£n l√Ω bookmark s·∫£n ph·∫©m ƒë√£ thu th·∫≠p" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="../assets/vendor/fonts/iconify-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/vendor/css/core.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>
    <script src="../assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y -->
    <div id="app-layout"></div>

    <!-- Core JS -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../assets/vendor/js/menu.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/layout.js"></script>

    <!-- Page JS -->
    <script>
      // Kh·ªüi t·∫°o layout manager
      const layoutManager = new LayoutManager();
      
      // N·ªôi dung trang Bookmark Management
      const pageContent = `
        <!-- Header -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="d-flex align-items-start row">
                <div class="col-sm-7">
                  <div class="card-body">
                    <h5 class="card-title text-primary mb-3">üîñ Qu·∫£n l√Ω Bookmark</h5>
                    <p class="mb-6">
                      Xem v√† qu·∫£n l√Ω c√°c bookmark s·∫£n ph·∫©m ƒë√£ thu th·∫≠p.<br />
                      Theo d√µi s·∫£n ph·∫©m m·ªõi v√† tr√πng l·∫∑p.
                    </p>
                  </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                  <div class="card-body pb-0 px-0 px-md-6">
                    <img
                      src="../assets/img/illustrations/man-with-laptop.png"
                      height="175"
                      alt="Bookmark Management" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Site Selection -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Ch·ªçn Website</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="loadBookmarks()">
                  <i class="bx bx-refresh me-1"></i>T·∫£i l·∫°i
                </button>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label for="bookmarkSiteSelect" class="form-label">Website:</label>
                    <select class="form-select" id="bookmarkSiteSelect" onchange="changeBookmarkSite()">
                      <option value="">Ch·ªçn website...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Th·ªëng k√™:</label>
                    <div id="bookmarkStats" class="mt-2">
                      <span class="badge bg-secondary">Ch∆∞a ch·ªçn website</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bookmark List -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Danh s√°ch Bookmark</h5>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-danger btn-sm" onclick="clearBookmarks()">
                    <i class="bx bx-trash me-1"></i>X√≥a t·∫•t c·∫£
                  </button>
                  <button class="btn btn-outline-info btn-sm" onclick="exportBookmarks()">
                    <i class="bx bx-download me-1"></i>Xu·∫•t bookmark
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>H√¨nh ·∫£nh</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Gi√°</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Th·ªùi gian</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody id="bookmarkTable">
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                          </div>
                          <p class="mt-2 text-muted">ƒêang t·∫£i bookmark...</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Variables
      let currentBookmarkSite = null;

      // Render layout khi trang load
      document.addEventListener('DOMContentLoaded', function() {
        CommonUtils.checkLoginStatus();
        layoutManager.renderLayout('app-layout', pageContent);
        loadSites();
      });

      // Load sites
      async function loadSites() {
        await CommonUtils.loadSites();
        CommonUtils.populateSiteSelect('bookmarkSiteSelect');
      }

      // Change bookmark site
      async function changeBookmarkSite() {
        const siteKey = document.getElementById('bookmarkSiteSelect').value;
        
        if (!siteKey) {
          currentBookmarkSite = null;
          CommonUtils.updateConnectionStatus('Ch∆∞a ch·ªçn website', 'secondary', 'bookmarkStats');
          CommonUtils.showEmptyState('bookmarkTable', 'bx-bookmark', 'Ch∆∞a ch·ªçn website', 'Vui l√≤ng ch·ªçn website ƒë·ªÉ xem bookmark');
          return;
        }

        currentBookmarkSite = CommonUtils.sites.find(s => s.key === siteKey);
        await loadBookmarks();
      }

      // Load bookmarks
      async function loadBookmarks() {
        if (!currentBookmarkSite) {
          CommonUtils.showEmptyState('bookmarkTable', 'bx-bookmark', 'Ch∆∞a ch·ªçn website', 'Vui l√≤ng ch·ªçn website ƒë·ªÉ xem bookmark');
          return;
        }

        CommonUtils.showLoading('bookmarkTable', 'ƒêang t·∫£i bookmark...');

        try {
          const response = await fetch(`/api/bookmarks?siteKey=${currentBookmarkSite.key}`);
          const data = await response.json();
          
          if (data.success) {
            updateBookmarkTable(data.data);
            updateBookmarkStats(data.data);
          } else {
            CommonUtils.showAlert('L·ªói khi t·∫£i bookmark: ' + data.message, 'error');
            CommonUtils.showEmptyState('bookmarkTable', 'bx-error', 'L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i bookmark');
          }
        } catch (error) {
          console.error('Error loading bookmarks:', error);
          CommonUtils.showAlert('L·ªói khi t·∫£i bookmark', 'error');
          CommonUtils.showEmptyState('bookmarkTable', 'bx-error', 'L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i bookmark');
        }
      }

      // Update bookmark table
      function updateBookmarkTable(bookmarks) {
        const tbody = document.getElementById('bookmarkTable');
        
        if (bookmarks.length === 0) {
          CommonUtils.showEmptyState('bookmarkTable', 'bx-bookmark', 'Ch∆∞a c√≥ bookmark', 'Ch∆∞a c√≥ bookmark n√†o cho website n√†y');
          return;
        }

        const html = bookmarks.map(bookmark => {
          const statusClass = bookmark.isDuplicate ? 'warning' : 'success';
          const statusText = bookmark.isDuplicate ? 'Tr√πng l·∫∑p' : 'M·ªõi';
          const statusIcon = bookmark.isDuplicate ? 'bx-time' : 'bx-check-circle';
          const timestamp = CommonUtils.formatDate(bookmark.timestamp || new Date());
          
          return `
            <tr>
              <td>
                <img src="${bookmark.images?.[0] || '../assets/img/illustrations/man-with-laptop.png'}" 
                     alt="${bookmark.name}" 
                     class="rounded" 
                     style="width: 50px; height: 50px; object-fit: cover;">
              </td>
              <td>
                <h6 class="mb-0">${bookmark.name || 'N/A'}</h6>
                <small class="text-muted">${bookmark.permalink || ''}</small>
              </td>
              <td>
                <span class="fw-bold text-success">${bookmark.price || 'N/A'}</span>
              </td>
              <td>
                <span class="badge bg-${statusClass}">
                  <i class="bx ${statusIcon} me-1"></i>${statusText}
                </span>
              </td>
              <td>
                <small class="text-muted">${timestamp}</small>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="${bookmark.permalink}" target="_blank">
                      <i class="bx bx-link-external me-2"></i>Xem s·∫£n ph·∫©m
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="copyProductLink('${bookmark.permalink}')">
                      <i class="bx bx-copy me-2"></i>Sao ch√©p link
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="removeBookmark('${bookmark.id}')">
                      <i class="bx bx-trash me-2"></i>X√≥a bookmark
                    </a></li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = html;
      }

      // Update bookmark stats
      function updateBookmarkStats(bookmarks) {
        const totalBookmarks = bookmarks.length;
        const duplicates = bookmarks.filter(b => b.isDuplicate).length;
        const newBookmarks = totalBookmarks - duplicates;
        const duplicateRate = totalBookmarks > 0 ? ((duplicates / totalBookmarks) * 100).toFixed(1) : 0;

        const statsHtml = `
          <div class="d-flex gap-2 flex-wrap">
            <span class="badge bg-primary">T·ªïng: ${totalBookmarks}</span>
            <span class="badge bg-success">M·ªõi: ${newBookmarks}</span>
            <span class="badge bg-warning">Tr√πng: ${duplicates}</span>
            <span class="badge bg-info">T·ª∑ l·ªá tr√πng: ${duplicateRate}%</span>
          </div>
        `;

        document.getElementById('bookmarkStats').innerHTML = statsHtml;
      }

      // Copy product link
      function copyProductLink(link) {
        CommonUtils.copyToClipboard(link);
      }

      // Remove bookmark
      function removeBookmark(bookmarkId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a bookmark n√†y?')) {
          CommonUtils.showAlert('ƒê√£ x√≥a bookmark!', 'success');
          loadBookmarks();
        }
      }

      // Clear bookmarks
      async function clearBookmarks() {
        if (!currentBookmarkSite) {
          CommonUtils.showAlert('Vui l√≤ng ch·ªçn website tr∆∞·ªõc!', 'warning');
          return;
        }

        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ bookmark c·ªßa ${currentBookmarkSite.name}?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/bookmarks?siteKey=${currentBookmarkSite.key}`, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            CommonUtils.showAlert('ƒê√£ x√≥a t·∫•t c·∫£ bookmark th√†nh c√¥ng!', 'success');
            loadBookmarks();
          } else {
            CommonUtils.showAlert('L·ªói khi x√≥a bookmark: ' + data.message, 'error');
          }
        } catch (error) {
          console.error('Error clearing bookmarks:', error);
          CommonUtils.showAlert('L·ªói khi x√≥a bookmark', 'error');
        }
      }

      // Export bookmarks
      function exportBookmarks() {
        if (!currentBookmarkSite) {
          CommonUtils.showAlert('Vui l√≤ng ch·ªçn website tr∆∞·ªõc!', 'warning');
          return;
        }

        CommonUtils.showAlert('ƒêang xu·∫•t bookmark...', 'info');
        
        // Simulate export
        setTimeout(() => {
          CommonUtils.showAlert('ƒê√£ xu·∫•t bookmark th√†nh c√¥ng!', 'success');
        }, 2000);
      }
    </script>
  </body>
</html>
