<!doctype html>

<html
  lang="vi"
  class="layout-menu-fixed layout-compact"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Qu·∫£n l√Ω Crawler - Tool Craw Data ƒêa Lu·ªìng</title>

    <meta name="description" content="Qu·∫£n l√Ω thu th·∫≠p d·ªØ li·ªáu s·∫£n ph·∫©m" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="../assets/vendor/fonts/iconify-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/vendor/css/core.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>
    <script src="../assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y -->
    <div id="app-layout"></div>

    <!-- Core JS -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../assets/vendor/js/menu.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/layout.js"></script>

    <!-- Page JS -->
    <script>
      // Kh·ªüi t·∫°o layout manager
      const layoutManager = new LayoutManager();
      
      // N·ªôi dung trang Crawler Management
      const pageContent = `
        <!-- Header -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="d-flex align-items-start row">
                <div class="col-sm-7">
                  <div class="card-body">
                    <h5 class="card-title text-primary mb-3">üï∑Ô∏è Qu·∫£n l√Ω Crawler</h5>
                    <p class="mb-6">
                      Thu th·∫≠p d·ªØ li·ªáu s·∫£n ph·∫©m t·ª´ c√°c website.<br />
                      Qu·∫£n l√Ω ti·∫øn ƒë·ªô v√† theo d√µi k·∫øt qu·∫£ thu th·∫≠p.
                    </p>
                  </div>
                </div>
                <div class="col-sm-5 text-center text-sm-left">
                  <div class="card-body pb-0 px-0 px-md-6">
                    <img
                      src="../assets/img/illustrations/man-with-laptop.png"
                      height="175"
                      alt="Crawler Management" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Site Selection -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Ch·ªçn Website</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="testConnection()">
                  <i class="bx bx-test-tube me-1"></i>Test k·∫øt n·ªëi
                </button>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label for="crawlerSiteSelect" class="form-label">Website:</label>
                    <select class="form-select" id="crawlerSiteSelect" onchange="changeCrawlerSite()">
                      <option value="">Ch·ªçn website...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Tr·∫°ng th√°i k·∫øt n·ªëi:</label>
                    <div id="crawlerConnectionStatus" class="mt-2">
                      <span class="badge bg-secondary">Ch∆∞a ch·ªçn website</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Crawler Controls -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">ƒêi·ªÅu khi·ªÉn Crawler</h5>
                <div class="btn-group" role="group">
                  <button class="btn btn-success" onclick="startCrawling()" id="startBtn">
                    <i class="bx bx-play me-1"></i>B·∫Øt ƒë·∫ßu
                  </button>
                  <button class="btn btn-warning" onclick="pauseCrawling()" id="pauseBtn" disabled>
                    <i class="bx bx-pause me-1"></i>T·∫°m d·ª´ng
                  </button>
                  <button class="btn btn-danger" onclick="stopCrawling()" id="stopBtn" disabled>
                    <i class="bx bx-stop me-1"></i>D·ª´ng
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <label for="maxPages" class="form-label">S·ªë trang t·ªëi ƒëa:</label>
                    <input type="number" class="form-control" id="maxPages" value="5" min="1" max="50">
                  </div>
                  <div class="col-md-3">
                    <label for="perPage" class="form-label">S·∫£n ph·∫©m m·ªói trang:</label>
                    <input type="number" class="form-control" id="perPage" value="20" min="1" max="100">
                  </div>
                  <div class="col-md-3">
                    <label for="orderBy" class="form-label">S·∫Øp x·∫øp theo:</label>
                    <select class="form-select" id="orderBy">
                      <option value="date" selected>Ng√†y</option>
                      <option value="price">Gi√°</option>
                      <option value="name">T√™n</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="order" class="form-label">Th·ª© t·ª±:</label>
                    <select class="form-select" id="order">
                      <option value="desc" selected>Gi·∫£m d·∫ßn</option>
                      <option value="asc">TƒÉng d·∫ßn</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title mb-0">Ti·∫øn ƒë·ªô thu th·∫≠p</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2">
                      <span>Trang hi·ªán t·∫°i:</span>
                      <span id="currentPage">0</span>
                    </div>
                    <div class="progress mb-3">
                      <div class="progress-bar" id="pageProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2">
                      <span>S·∫£n ph·∫©m ƒë√£ thu th·∫≠p:</span>
                      <span id="collectedProducts">0</span>
                    </div>
                    <div class="progress">
                      <div class="progress-bar bg-success" id="productProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="d-flex justify-content-between">
                    <span>Tr·∫°ng th√°i:</span>
                    <span id="crawlerStatus" class="badge bg-secondary">Ch∆∞a b·∫Øt ƒë·∫ßu</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Results -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">K·∫øt qu·∫£ thu th·∫≠p</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                  <i class="bx bx-download me-1"></i>Xu·∫•t k·∫øt qu·∫£
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>H√¨nh ·∫£nh</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Gi√°</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Th·ªùi gian</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody id="crawlerResults">
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                          </div>
                          <p class="mt-2 text-muted">ƒêang t·∫£i k·∫øt qu·∫£...</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Variables
      let currentCrawlerSite = null;
      let isCrawling = false;
      let crawlingInterval = null;

      // Render layout khi trang load
      document.addEventListener('DOMContentLoaded', function() {
        CommonUtils.checkLoginStatus();
        layoutManager.renderLayout('app-layout', pageContent);
        loadSites();
        loadCrawlerResults();
      });

      // Load sites
      async function loadSites() {
        await CommonUtils.loadSites();
        CommonUtils.populateSiteSelect('crawlerSiteSelect');
      }

      // Change crawler site
      async function changeCrawlerSite() {
        const siteKey = document.getElementById('crawlerSiteSelect').value;
        
        if (!siteKey) {
          currentCrawlerSite = null;
          CommonUtils.updateConnectionStatus('Ch∆∞a ch·ªçn website', 'secondary', 'crawlerConnectionStatus');
          return;
        }

        currentCrawlerSite = CommonUtils.sites.find(s => s.key === siteKey);
        await CommonUtils.changeSite(siteKey, 'crawlerConnectionStatus');
      }

      // Test connection
      async function testConnection() {
        if (!currentCrawlerSite) {
          CommonUtils.showAlert('Vui l√≤ng ch·ªçn website tr∆∞·ªõc!', 'warning');
          return;
        }

        CommonUtils.showAlert('ƒêang test k·∫øt n·ªëi...', 'info');
        
        try {
          const response = await fetch(`/api/test-connection?siteKey=${currentCrawlerSite.key}`);
          const data = await response.json();
          
          if (data.success && data.data.connected) {
            CommonUtils.showAlert('K·∫øt n·ªëi th√†nh c√¥ng!', 'success');
            CommonUtils.updateConnectionStatus('K·∫øt n·ªëi th√†nh c√¥ng', 'success', 'crawlerConnectionStatus');
          } else {
            CommonUtils.showAlert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn website!', 'error');
            CommonUtils.updateConnectionStatus('Kh√¥ng th·ªÉ k·∫øt n·ªëi', 'danger', 'crawlerConnectionStatus');
          }
        } catch (error) {
          console.error('Error testing connection:', error);
          CommonUtils.showAlert('L·ªói khi test k·∫øt n·ªëi!', 'error');
        }
      }

      // Start crawling
      async function startCrawling() {
        if (!currentCrawlerSite) {
          CommonUtils.showAlert('Vui l√≤ng ch·ªçn website tr∆∞·ªõc!', 'warning');
          return;
        }

        const maxPages = parseInt(document.getElementById('maxPages').value);
        const perPage = parseInt(document.getElementById('perPage').value);
        const orderBy = document.getElementById('orderBy').value;
        const order = document.getElementById('order').value;

        isCrawling = true;
        updateCrawlerButtons();
        updateCrawlerStatus('ƒêang thu th·∫≠p...', 'warning');

        try {
          const response = await fetch('/api/start-crawling', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              siteKey: currentCrawlerSite.key,
              maxPages,
              perPage,
              orderBy,
              order
            })
          });

          const data = await response.json();
          
          if (data.success) {
            CommonUtils.showAlert('B·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu!', 'success');
            startProgressSimulation();
          } else {
            CommonUtils.showAlert('L·ªói khi b·∫Øt ƒë·∫ßu thu th·∫≠p: ' + data.message, 'error');
            isCrawling = false;
            updateCrawlerButtons();
            updateCrawlerStatus('L·ªói', 'danger');
          }
        } catch (error) {
          console.error('Error starting crawling:', error);
          CommonUtils.showAlert('L·ªói khi b·∫Øt ƒë·∫ßu thu th·∫≠p!', 'error');
          isCrawling = false;
          updateCrawlerButtons();
          updateCrawlerStatus('L·ªói', 'danger');
        }
      }

      // Pause crawling
      function pauseCrawling() {
        if (crawlingInterval) {
          clearInterval(crawlingInterval);
          crawlingInterval = null;
        }
        
        isCrawling = false;
        updateCrawlerButtons();
        updateCrawlerStatus('ƒê√£ t·∫°m d·ª´ng', 'warning');
        CommonUtils.showAlert('ƒê√£ t·∫°m d·ª´ng thu th·∫≠p!', 'info');
      }

      // Stop crawling
      function stopCrawling() {
        if (crawlingInterval) {
          clearInterval(crawlingInterval);
          crawlingInterval = null;
        }
        
        isCrawling = false;
        updateCrawlerButtons();
        updateCrawlerStatus('ƒê√£ d·ª´ng', 'secondary');
        resetProgress();
        CommonUtils.showAlert('ƒê√£ d·ª´ng thu th·∫≠p!', 'info');
      }

      // Update crawler buttons
      function updateCrawlerButtons() {
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');

        if (isCrawling) {
          startBtn.disabled = true;
          pauseBtn.disabled = false;
          stopBtn.disabled = false;
        } else {
          startBtn.disabled = false;
          pauseBtn.disabled = true;
          stopBtn.disabled = true;
        }
      }

      // Update crawler status
      function updateCrawlerStatus(message, type) {
        const status = document.getElementById('crawlerStatus');
        status.textContent = message;
        status.className = `badge bg-${type}`;
      }

      // Start progress simulation
      function startProgressSimulation() {
        let currentPage = 0;
        let collectedProducts = 0;
        const maxPages = parseInt(document.getElementById('maxPages').value);
        const perPage = parseInt(document.getElementById('perPage').value);

        crawlingInterval = setInterval(() => {
          if (!isCrawling) return;

          currentPage++;
          collectedProducts += Math.floor(Math.random() * perPage) + 1;

          // Update progress
          const pageProgress = (currentPage / maxPages) * 100;
          const productProgress = Math.min((collectedProducts / (maxPages * perPage)) * 100, 100);

          document.getElementById('currentPage').textContent = currentPage;
          document.getElementById('collectedProducts').textContent = collectedProducts;
          document.getElementById('pageProgress').style.width = pageProgress + '%';
          document.getElementById('productProgress').style.width = productProgress + '%';

          // Check if completed
          if (currentPage >= maxPages) {
            stopCrawling();
            updateCrawlerStatus('Ho√†n th√†nh', 'success');
            CommonUtils.showAlert('Thu th·∫≠p d·ªØ li·ªáu ho√†n th√†nh!', 'success');
            loadCrawlerResults();
          }
        }, 2000);
      }

      // Reset progress
      function resetProgress() {
        document.getElementById('currentPage').textContent = '0';
        document.getElementById('collectedProducts').textContent = '0';
        document.getElementById('pageProgress').style.width = '0%';
        document.getElementById('productProgress').style.width = '0%';
      }

      // Load crawler results
      async function loadCrawlerResults() {
        if (!currentCrawlerSite) {
          CommonUtils.showEmptyState('crawlerResults', 'bx-data', 'Ch∆∞a ch·ªçn website', 'Vui l√≤ng ch·ªçn website ƒë·ªÉ xem k·∫øt qu·∫£');
          return;
        }

        try {
          const response = await fetch(`/api/crawler-results?siteKey=${currentCrawlerSite.key}`);
          const data = await response.json();
          
          if (data.success) {
            updateCrawlerResultsTable(data.data);
          } else {
            CommonUtils.showEmptyState('crawlerResults', 'bx-error', 'L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£ thu th·∫≠p');
          }
        } catch (error) {
          console.error('Error loading crawler results:', error);
          CommonUtils.showEmptyState('crawlerResults', 'bx-error', 'L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£ thu th·∫≠p');
        }
      }

      // Update crawler results table
      function updateCrawlerResultsTable(results) {
        const tbody = document.getElementById('crawlerResults');
        
        if (results.length === 0) {
          CommonUtils.showEmptyState('crawlerResults', 'bx-data', 'Ch∆∞a c√≥ k·∫øt qu·∫£', 'Ch∆∞a c√≥ k·∫øt qu·∫£ thu th·∫≠p n√†o');
          return;
        }

        const html = results.map(result => {
          const statusClass = result.isNew ? 'success' : 'warning';
          const statusText = result.isNew ? 'M·ªõi' : 'Tr√πng l·∫∑p';
          const statusIcon = result.isNew ? 'bx-check-circle' : 'bx-time';
          const timestamp = CommonUtils.formatDate(result.timestamp || new Date());
          
          return `
            <tr>
              <td>
                <img src="${result.images?.[0] || '../assets/img/illustrations/man-with-laptop.png'}" 
                     alt="${result.name}" 
                     class="rounded" 
                     style="width: 50px; height: 50px; object-fit: cover;">
              </td>
              <td>
                <h6 class="mb-0">${result.name || 'N/A'}</h6>
                <small class="text-muted">${result.permalink || ''}</small>
              </td>
              <td>
                <span class="fw-bold text-success">${result.price || 'N/A'}</span>
              </td>
              <td>
                <span class="badge bg-${statusClass}">
                  <i class="bx ${statusIcon} me-1"></i>${statusText}
                </span>
              </td>
              <td>
                <small class="text-muted">${timestamp}</small>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="${result.permalink}" target="_blank">
                      <i class="bx bx-link-external me-2"></i>Xem s·∫£n ph·∫©m
                    </a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="copyProductLink('${result.permalink}')">
                      <i class="bx bx-copy me-2"></i>Sao ch√©p link
                    </a></li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = html;
      }

      // Copy product link
      function copyProductLink(link) {
        CommonUtils.copyToClipboard(link);
      }

      // Export results
      async function exportResults() {
        if (!currentCrawlerSite) {
          CommonUtils.showAlert('Vui l√≤ng ch·ªçn website tr∆∞·ªõc!', 'warning');
          return;
        }

        CommonUtils.showAlert('ƒêang xu·∫•t k·∫øt qu·∫£...', 'info');
        
        try {
          // L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m t·ª´ bookmark
          const response = await fetch(`/api/bookmarks?siteKey=${currentCrawlerSite.key}`);
          const data = await response.json();
          
          if (data.success && data.data.length > 0) {
            // Xu·∫•t d·ªØ li·ªáu
            const exportResponse = await fetch('/api/export-data', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                siteKey: currentCrawlerSite.key,
                format: 'csv',
                productStatus: 'all',
                maxRecords: 0, // 0 = t·∫•t c·∫£
                fields: ['name', 'price', 'image', 'link', 'site', 'date', 'status']
              })
            });

            const exportData = await exportResponse.json();
            
            if (exportData.success) {
              CommonUtils.showAlert(`ƒê√£ xu·∫•t ${exportData.data.recordCount} s·∫£n ph·∫©m th√†nh c√¥ng!`, 'success');
              
              // T·ª± ƒë·ªông t·∫£i file
              if (exportData.data.downloadUrl) {
                setTimeout(() => {
                  const link = document.createElement('a');
                  link.href = exportData.data.downloadUrl;
                  link.download = exportData.data.filename;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                }, 1000);
              }
            } else {
              CommonUtils.showAlert('L·ªói khi xu·∫•t d·ªØ li·ªáu: ' + exportData.message, 'error');
            }
          } else {
            CommonUtils.showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
          }
        } catch (error) {
          console.error('Error exporting results:', error);
          CommonUtils.showAlert('L·ªói khi xu·∫•t k·∫øt qu·∫£!', 'error');
        }
      }
    </script>
  </body>
</html>
